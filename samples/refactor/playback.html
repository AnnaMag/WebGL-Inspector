<html>
<head>
    <title>Playback Test</title>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

    <script type="text/javascript" src="../../core/loader.js"></script>

    <script type="text/javascript">
        gliloader.pathRoot = "../../core/";
        gliloader.load(["playback"]);
    </script>

    <script type="text/javascript">
        var host = null;
        var session = null;
        var context1;
        var context2;
        var context3;
        var replayCanvas1;
        var replayCanvas2;
        var replayCanvas3;
        var stepButton;
        var runButton;
        
        function clearCanvas(canvas) {
            var ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };
        
        var readyCount = 0;
        function contextReady() {
            readyCount--;
            if (readyCount == 0) {
                stepButton.removeAttribute("disabled");
                runButton.removeAttribute("disabled");
            }
        };

        function DocumentLoaded() {
            replayCanvas1 = document.getElementById("replayCanvas1");
            replayCanvas2 = document.getElementById("replayCanvas2");
            replayCanvas3 = document.getElementById("replayCanvas3");
            var inputArea = document.getElementById("inputArea");
            var loadButton = document.getElementById("loadButton");
            var frameList = document.getElementById("frameList");
            stepButton = document.getElementById("stepButton");
            runButton = document.getElementById("runButton");
            
            loadButton.onclick = function () {
                var source = inputArea.value;
                var storage = JSON.parse(source);
                console.log(storage);
                
                loadButton.disabled = true;

                host = new gli.playback.PlaybackHost(document);
                
                transport = new gli.playback.transports.JsonTransport(storage);
                session = host.openSession(transport);
                
                var firstCall = true;
                session.captureFrameAdded.addListener(this, function captureFrameAdded(frame) {
                    var option = document.createElement("option");
                    option.innerHTML = "Frame " + frame.frameNumber;
                    option.value = frame.frameNumber;
                    frameList.appendChild(option);
                    if (firstCall) {
                        firstCall = false;
                        frameList.onchange();
                    }
                });
                
                context1 = new gli.playback.PlaybackContext(session, {
                    ignoreCrossDomainContent: false
                }, [
                    // mutators
                ]);
                context1.ready.addListener(this, contextReady);
                context1.preFrame.addListener(this, preFrame);
                context1.stepped.addListener(this, stepped);
                
                context2 = new gli.playback.PlaybackContext(session, {
                    ignoreCrossDomainContent: false
                }, [
                    // mutators
                    new gli.playback.mutators.ShaderOverrideMutator("FRAGMENT_SHADER",
                        "precision highp float;\n" +
                        "void main() {\n" +
                        "    gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);\n" +
                        "}\n"
                    )
                ]);
                context2.ready.addListener(this, contextReady);
                context2.preFrame.addListener(this, preFrame);
                context2.stepped.addListener(this, stepped);
                
                context3 = new gli.playback.PlaybackContext(session, {
                    ignoreCrossDomainContent: true
                }, [
                    // mutators
                    new gli.playback.mutators.DepthOutputMutator()
                ]);
                context3.ready.addListener(this, contextReady);
                context3.preFrame.addListener(this, preFrame);
                context3.stepped.addListener(this, stepped);
            };
            
            frameList.onchange = function () {
                var frameNumber = Number(frameList.options[frameList.selectedIndex].value);
                var frames = session.storage.captureFrames;
                for (var n = 0; n < frames.length; n++) {
                    var frame = frames[n];
                    if (frame.frameNumber === frameNumber) {
                        setFrame(frame);
                    }
                }
            };
            
            stepButton.onclick = function () {
                context1.step(1);
                context2.step(1);
                context3.step(1);
            };
            
            runButton.onclick = function () {
                context1.run();
                context2.run();
                context3.run();
            };
        };
        
        function setFrame(frame) {
            readyCount = 3;
            
            replayCanvas1.width = frame.canvasInfo.width;
            replayCanvas1.height = frame.canvasInfo.height;
            replayCanvas2.width = frame.canvasInfo.width;
            replayCanvas2.height = frame.canvasInfo.height;
            replayCanvas3.width = frame.canvasInfo.width;
            replayCanvas3.height = frame.canvasInfo.height;
            
            clearCanvas(replayCanvas1);
            clearCanvas(replayCanvas2);
            clearCanvas(replayCanvas3);
            
            context1.setFrame(frame);
            context2.setFrame(frame);
            context3.setFrame(frame);
        };
        
        function preFrame(context, frame) {
            if (context == context1) {
                clearCanvas(replayCanvas1);
            } else if (context == context2) {
                clearCanvas(replayCanvas2);
            } else if (context == context3) {
                clearCanvas(replayCanvas3);
            }
        };
        
        function testReadback(gl) {
            try {
                var pixels = new Uint8Array(4);
                gl.readPixels(0, 0, 1, 1, gl.RGBA, gl.UNSIGNED_BYTE, pixels);
                console.log("read back");
            } catch (e) {
                console.log("failed to read back");
            }
        };
        
        function stepped(context) {
            if (context == context1) {
                //testReadback(context.gl);
                context.present(replayCanvas1);
            } else if (context == context2) {
                //testReadback(context.gl);
                context.present(replayCanvas2);
            } else if (context == context3) {
                //testReadback(context.gl);
                context.present(replayCanvas3);
            }
        };
        
    </script>

</head>
<body onload="DocumentLoaded();">
    <canvas id="replayCanvas1" style="border: none;"></canvas>
    <canvas id="replayCanvas2" style="border: none;"></canvas>
    <canvas id="replayCanvas3" style="border: none;"></canvas>
    <br />
    <input type="submit" id="stepButton" value="Step" disabled />
    <input type="submit" id="runButton" value="Run" disabled />
    <br />
    <select id="frameList">
    </select>
    <br />
    <textarea id="inputArea"></textarea>
    <br />
    <input type="submit" id="loadButton" value="Load" />
</body>
</html>
