<html>
<head>
    <title>Playback Test</title>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">

    <script type="text/javascript" src="../../core/loader.js"></script>

    <script type="text/javascript">
        gliloader.pathRoot = "../../core/";
        gliloader.load(["playback"]);
    </script>

    <script type="text/javascript">
        var host = null;
        var session = null;
        var context1;
        var context2;
        var replayCanvas1;
        var replayCanvas2;
        var stepButton;
        var runButton;
        
        function clearCanvas(canvas) {
            var ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };
        
        var readyCount = 0;
        function contextReady() {
            readyCount--;
            if (readyCount == 0) {
                stepButton.removeAttribute("disabled");
                runButton.removeAttribute("disabled");
            }
        };

        function DocumentLoaded() {
            replayCanvas1 = document.getElementById("replayCanvas1");
            replayCanvas2 = document.getElementById("replayCanvas2");
            var inputArea = document.getElementById("inputArea");
            var loadButton = document.getElementById("loadButton");
            var frameList = document.getElementById("frameList");
            stepButton = document.getElementById("stepButton");
            runButton = document.getElementById("runButton");
            
            loadButton.onclick = function () {
                var source = inputArea.value;
                var storage = JSON.parse(source);
                console.log(storage);

                host = new gli.playback.PlaybackHost(document);
                
                transport = new gli.playback.transports.JsonTransport(storage);
                session = host.openSession(transport);
                
                session.captureFrameAdded.addListener(this, function captureFrameAdded(frame) {
                    var option = document.createElement("option");
                    option.innerHTML = "Frame " + frame.frameNumber;
                    option.value = frame.frameNumber;
                    frameList.appendChild(option);
                });
                
                context1 = new gli.playback.PlaybackContext(session, {
                    ignoreCrossDomainContent: false
                }, [
                    // mutators
                ]);
                context1.ready.addListener(this, contextReady);
                context1.stepped.addListener(this, stepped);
                
                context2 = new gli.playback.PlaybackContext(session, {
                    ignoreCrossDomainContent: true
                }, [
                    // mutators
                ]);
                context2.ready.addListener(this, contextReady);
                context2.stepped.addListener(this, stepped);
            };
            
            frameList.onchange = function () {
                var frameNumber = Number(frameList.options[frameList.selectedIndex].value);
                var frames = session.storage.captureFrames;
                for (var n = 0; n < frames.length; n++) {
                    var frame = frames[n];
                    if (frame.frameNumber === frameNumber) {
                        setFrame(frame);
                    }
                }
            };
            
            stepButton.onclick = function () {
                context1.step(1);
                context2.step(1);
            };
            
            runButton.onclick = function () {
                context1.run();
                context2.run();
            };
        };
        
        function setFrame(frame) {
            readyCount = 2;
            
            replayCanvas1.width = frame.canvasInfo.width;
            replayCanvas1.height = frame.canvasInfo.height;
            replayCanvas2.width = frame.canvasInfo.width;
            replayCanvas2.height = frame.canvasInfo.height;
            
            clearCanvas(replayCanvas1);
            clearCanvas(replayCanvas2);
            
            context1.setFrame(frame);
            context2.setFrame(frame);
        };
        
        function stepped(context) {
            context1.present(replayCanvas1);
            context2.present(replayCanvas2);
        };
        
    </script>

</head>
<body onload="DocumentLoaded();">
    <canvas id="replayCanvas1" style="border: none;"></canvas>
    <canvas id="replayCanvas2" style="border: none;"></canvas>
    <br />
    <input type="submit" id="stepButton" value="Step" disabled />
    <input type="submit" id="runButton" value="Run" disabled />
    <br />
    <select id="frameList">
    </select>
    <br />
    <textarea id="inputArea"></textarea>
    <br />
    <input type="submit" id="loadButton" value="Load" />
</body>
</html>
